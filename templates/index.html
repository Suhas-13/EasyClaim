<!DOCTYPE html>
<html>
<head>
    <title>Claim Assistant</title>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <style>
        .option-button {
            margin: 5px;
            padding: 8px 12px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .option-button:hover {
            background-color: #0056b3;
        }
        #chat-window p {
            margin: 5px 0;
        }
        .file-link {
            display: block;
            margin: 5px 0;
            color: #007BFF;
        }
        .sender-user {
            color: blue;
        }
        .sender-assistant {
            color: green;
        }
        #chat-container {
            display: none; /* Initially hide the chat container */
        }
        #claims-list ul {
            list-style-type: none;
            padding: 0;
        }
        #claims-list li {
            margin: 5px 0;
        }
        #claims-list a {
            margin-left: 10px;
            color: #007BFF;
        }
    </style>
</head>
<body>
    <h1>Claim Assistant Chat</h1>

    <!-- Display User's Claims -->
    <div id="claims-list">
        {% if claims %}
            <h2>Your Claims</h2>
            <ul>
                {% for claim in claims %}
                    <li>
                        <strong>Claim ID:</strong> {{ claim.id }} - <strong>Status:</strong> {{ claim.status }}
                        <a href="{{ url_for('view_claim', claim_id=claim.id) }}">View Chat</a>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>You have no claims yet.</p>
        {% endif %}
        <button id="start-claim-button">Start a New Claim</button>
    </div>

    <!-- Chat Interface -->
    <div id="chat-container">
        <div id="chat-window" style="border:1px solid #ccc; padding:10px; width:600px; height:400px; overflow-y:scroll;">
        </div>
        <input type="text" id="message-input" placeholder="Type your message..." style="width:500px;">
        <button id="send-button">Send</button>
        <input type="file" id="file-input" multiple style="display:none;">
        <button id="upload-button">Upload Files</button>
    </div>

    <script>
        var transactionDetails = {
            transaction_name: "{{ transaction_details.transaction_name }}",
            date: "{{ transaction_details.date }}",
            merchant_name: "{{ transaction_details.merchant_name }}",
            merchant_email: "{{ transaction_details.merchant_email }}",
            transaction_id: "{{ transaction_details.transaction_id }}"
        };

        var socket;
        var chatWindow = document.getElementById('chat-window');
        var messageInput = document.getElementById('message-input');
        var sendButton = document.getElementById('send-button');
        var fileInput = document.getElementById('file-input');
        var uploadButton = document.getElementById('upload-button');
        var startClaimButton = document.getElementById('start-claim-button');
        var chatContainer = document.getElementById('chat-container');
        var claimsList = document.getElementById('claims-list');

        // Extract claim_id from the URL if available
        var claimId = null;
        var pathParts = window.location.pathname.split('/');
        if (pathParts[1] === 'claim' && pathParts[2]) {
            claimId = parseInt(pathParts[2]);
        }

        startClaimButton.addEventListener('click', function() {
            // Redirect to start a new claim
            window.location.href = '/start_new_claim';
        });

        // Initialize the chat if claimId is present
        if (claimId) {
            // Hide the claims list and show the chat container
            claimsList.style.display = 'none';
            chatContainer.style.display = 'block';

            // Initialize the socket connection
            socket = io({
                query: {
                    transaction_details: JSON.stringify(transactionDetails)
                }
            });

            socket.on('connect', function() {
                appendMessage('System: Connected to the server.');
                // Fetch previous messages
                fetchMessages(claimId);
            });

            socket.on('message', function(data) {
                // Remove existing options if any
                removeOptions();

                appendMessage('Assistant: ' + data.text);
                if (data.options && data.options.length > 0) {
                    displayOptions(data.options);
                }
            });

            socket.on('claim_summary', function(data) {
                displayClaimSummary(data.summary);
            });

            socket.on('disconnect', function() {
                appendMessage('System: Disconnected from the server.');
            });
        }

        sendButton.addEventListener('click', function() {
            var message = messageInput.value;
            if (message.trim() === '') return;
            appendMessage('You: ' + message);
            socket.emit('user_response', {'text': message});
            messageInput.value = '';
            // Remove options after user responds
            removeOptions();
        });

        uploadButton.addEventListener('click', function() {
            fileInput.click();
        });

        fileInput.addEventListener('change', function() {
            var files = fileInput.files;
            for (var i = 0; i < files.length; i++) {
                (function(file) {
                    var reader = new FileReader();
                    reader.onload = function(evt) {
                        var fileData = evt.target.result;
                        socket.emit('upload_file', {
                            'filename': file.name,
                            'file': fileData
                        });
                        appendMessage('You uploaded: ' + file.name);
                    };
                    reader.readAsDataURL(file);
                })(files[i]);
            }
            fileInput.value = '';
        });

        function appendMessage(message) {
            var p = document.createElement('p');
            p.innerHTML = message;
            chatWindow.appendChild(p);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function displayOptions(options) {
            var optionsContainer = document.createElement('div');
            optionsContainer.id = 'options-container';
            options.forEach(function(option) {
                var button = document.createElement('button');
                button.className = 'option-button';
                button.textContent = option;
                button.addEventListener('click', function() {
                    messageInput.value = option;
                });
                optionsContainer.appendChild(button);
            });
            chatWindow.appendChild(optionsContainer);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function removeOptions() {
            var existingOptions = document.getElementById('options-container');
            if (existingOptions) {
                existingOptions.parentNode.removeChild(existingOptions);
            }
        }

        function displayClaimSummary(summary) {
            var summaryDiv = document.getElementById('claim-summary');
            if (!summaryDiv) {
                summaryDiv = document.createElement('div');
                summaryDiv.id = 'claim-summary';
                summaryDiv.style.border = '1px solid #ccc';
                summaryDiv.style.padding = '10px';
                summaryDiv.style.marginTop = '10px';
                summaryDiv.innerHTML = '<h3>Claim Summary:</h3>';
                chatWindow.appendChild(summaryDiv);
            }
            summaryDiv.innerHTML = '<h3>Claim Summary:</h3>' + summary;
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function fetchMessages(claimId) {
            fetch('/get_messages/' + claimId)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        appendMessage('System: ' + data.error);
                        return;
                    }
                    var messages = data.messages;
                    var claimSummary = data.claim_summary;

                    // Render messages
                    messages.forEach(function(msg) {
                        var sender = msg.sender === 'user' ? 'You' : 'Assistant';
                        appendMessage(sender + ': ' + msg.content);
                    });

                    // Render claim summary if available
                    if (claimSummary) {
                        displayClaimSummary(claimSummary);
                    }
                })
                .catch(error => {
                    console.error('Error fetching messages:', error);
                    appendMessage('System: Error fetching messages.');
                });
        }
    </script>
</body>
</html>
